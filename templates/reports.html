{% extends "base.html" %}

{% block title %}Reports - Expense Tracker{% endblock %}

{% block content %}
<div class="row">
    <!-- Report Options -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <h4>Report Options</h4>
            </div>
            <div class="card-body">
                <div class="list-group">
                    <a href="#currentExpenses" class="list-group-item list-group-item-action active" data-bs-toggle="list">
                        Current Expenses Report
                    </a>
                    <a href="#categoryReport" class="list-group-item list-group-item-action" data-bs-toggle="list">
                        Category Report
                    </a>
                    <a href="#dateReport" class="list-group-item list-group-item-action" data-bs-toggle="list">
                        Date Range Report
                    </a>
                    <a href="#timeReport" class="list-group-item list-group-item-action" data-bs-toggle="list">
                        Time Range Report
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Content -->
    <div class="col-md-8">
        <div class="tab-content">
            <!-- Current Expenses Report -->
            <div class="tab-pane fade show active" id="currentExpenses">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4>Current Expenses Report</h4>
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="exportReport('current', 'csv')">Export CSV</button>
                            <button class="btn btn-primary" onclick="exportReport('current', 'excel')">Export Excel</button>
                            <button class="btn btn-primary" onclick="exportReport('current', 'pdf')">Export PDF</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Analytics Summary -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card bg-primary text-white">
                                    <div class="card-body">
                                        <h5 class="card-title">Total Expenses</h5>
                                        <h3 class="card-text">{{ "%.2f"|format(total_amount) }}</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-success text-white">
                                    <div class="card-body">
                                        <h5 class="card-title">Average Transaction</h5>
                                        <h3 class="card-text">{{ "%.2f"|format(avg_transaction) }}</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-info text-white">
                                    <div class="card-body">
                                        <h5 class="card-title">Total Transactions</h5>
                                        <h3 class="card-text">{{ total_transactions }}</h3>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Charts -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Expenses by Category</h5>
                                        <canvas id="categoryChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Monthly Trend</h5>
                                        <canvas id="monthlyChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Transactions Table -->
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Time</th>
                                        <th>Category</th>
                                        <th>Description</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for transaction in current_transactions %}
                                    <tr>
                                        <td>{{ transaction.tranDate.strftime('%d-%m-%Y') }}</td>
                                        <td>{{ transaction.tranTime }}</td>
                                        <td>{{ transaction.category.catName }}</td>
                                        <td>{{ transaction.tranDescription }}</td>
                                        <td class="text-end">{{ "%.2f"|format(transaction.tranAmount) }}</td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center">No transactions found</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="4" class="text-end"><strong>Total:</strong></td>
                                        <td class="text-end"><strong>{{ "%.2f"|format(total_amount) }}</strong></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Category Report -->
            <div class="tab-pane fade" id="categoryReport">
                <div class="card">
                    <div class="card-header">
                        <h4>Category Report</h4>
                    </div>
                    <div class="card-body">
                        <form method="GET" action="{{ url_for('category_report') }}" class="mb-4">
                            <div class="mb-3">
                                <label for="category" class="form-label">Select Category</label>
                                <select class="form-select" id="category" name="category" required>
                                    <option value="">Choose a category...</option>
                                    {% for category in categories %}
                                    <option value="{{ category.catID }}">{{ category.catName }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Generate Report</button>
                        </form>

                        {% if category_report %}
                        <!-- Category Analytics -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card bg-primary text-white">
                                    <div class="card-body">
                                        <h5 class="card-title">Category Total</h5>
                                        <h3 class="card-text">{{ "%.2f"|format(category_total) }}</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-success text-white">
                                    <div class="card-body">
                                        <h5 class="card-title">Average Transaction</h5>
                                        <h3 class="card-text">{{ "%.2f"|format(category_avg) }}</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-info text-white">
                                    <div class="card-body">
                                        <h5 class="card-title">Total Transactions</h5>
                                        <h3 class="card-text">{{ category_count }}</h3>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Category Chart -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title">Category Trend</h5>
                                <canvas id="categoryTrendChart"></canvas>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Time</th>
                                        <th>Description</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for transaction in category_report %}
                                    <tr>
                                        <td>{{ transaction.tranDate.strftime('%d-%m-%Y') }}</td>
                                        <td>{{ transaction.tranTime }}</td>
                                        <td>{{ transaction.tranDescription }}</td>
                                        <td class="text-end">{{ "%.2f"|format(transaction.tranAmount) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="3" class="text-end"><strong>Total:</strong></td>
                                        <td class="text-end"><strong>{{ "%.2f"|format(category_total) }}</strong></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Date Range Report -->
            <div class="tab-pane fade" id="dateReport">
                <div class="card">
                    <div class="card-header">
                        <h4>Date Range Report</h4>
                    </div>
                    <div class="card-body">
                        <form method="GET" action="{{ url_for('date_report') }}" class="mb-4">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="dateFrom" class="form-label">From Date</label>
                                        <input type="date" class="form-control" id="dateFrom" name="date_from" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="dateTo" class="form-label">To Date</label>
                                        <input type="date" class="form-control" id="dateTo" name="date_to" required>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Generate Report</button>
                        </form>

                        {% if date_report %}
                        <!-- Date Range Analytics -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card bg-primary text-white">
                                    <div class="card-body">
                                        <h5 class="card-title">Period Total</h5>
                                        <h3 class="card-text">{{ "%.2f"|format(date_total) }}</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-success text-white">
                                    <div class="card-body">
                                        <h5 class="card-title">Daily Average</h5>
                                        <h3 class="card-text">{{ "%.2f"|format(date_daily_avg) }}</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-info text-white">
                                    <div class="card-body">
                                        <h5 class="card-title">Total Transactions</h5>
                                        <h3 class="card-text">{{ date_count }}</h3>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Date Range Chart -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title">Daily Expenses Trend</h5>
                                <canvas id="dateRangeChart"></canvas>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Time</th>
                                        <th>Category</th>
                                        <th>Description</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for transaction in date_report %}
                                    <tr>
                                        <td>{{ transaction.tranDate.strftime('%d-%m-%Y') }}</td>
                                        <td>{{ transaction.tranTime }}</td>
                                        <td>{{ transaction.category.catName }}</td>
                                        <td>{{ transaction.tranDescription }}</td>
                                        <td class="text-end">{{ "%.2f"|format(transaction.tranAmount) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="4" class="text-end"><strong>Total:</strong></td>
                                        <td class="text-end"><strong>{{ "%.2f"|format(date_total) }}</strong></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Time Range Report -->
            <div class="tab-pane fade" id="timeReport">
                <div class="card">
                    <div class="card-header">
                        <h4>Time Range Report</h4>
                    </div>
                    <div class="card-body">
                        <form method="GET" action="{{ url_for('time_report') }}" class="mb-4">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="timeFrom" class="form-label">From Time</label>
                                        <input type="time" class="form-control" id="timeFrom" name="time_from" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="timeTo" class="form-label">To Time</label>
                                        <input type="time" class="form-control" id="timeTo" name="time_to" required>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Generate Report</button>
                        </form>

                        {% if time_report %}
                        <!-- Time Range Analytics -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card bg-primary text-white">
                                    <div class="card-body">
                                        <h5 class="card-title">Period Total</h5>
                                        <h3 class="card-text">{{ "%.2f"|format(time_total) }}</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-success text-white">
                                    <div class="card-body">
                                        <h5 class="card-title">Average Transaction</h5>
                                        <h3 class="card-text">{{ "%.2f"|format(time_avg) }}</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-info text-white">
                                    <div class="card-body">
                                        <h5 class="card-title">Total Transactions</h5>
                                        <h3 class="card-text">{{ time_count }}</h3>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Time Range Chart -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title">Hourly Distribution</h5>
                                <canvas id="timeRangeChart"></canvas>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Time</th>
                                        <th>Category</th>
                                        <th>Description</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for transaction in time_report %}
                                    <tr>
                                        <td>{{ transaction.tranDate.strftime('%d-%m-%Y') }}</td>
                                        <td>{{ transaction.tranTime }}</td>
                                        <td>{{ transaction.category.catName }}</td>
                                        <td>{{ transaction.tranDescription }}</td>
                                        <td class="text-end">{{ "%.2f"|format(transaction.tranAmount) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="4" class="text-end"><strong>Total:</strong></td>
                                        <td class="text-end"><strong>{{ "%.2f"|format(time_total) }}</strong></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Get data from template variables
    const categoryLabels = JSON.parse('{{ category_labels|tojson|safe }}');
    const categoryData = JSON.parse('{{ category_data|tojson|safe }}');
    const monthlyLabels = JSON.parse('{{ monthly_labels|tojson|safe }}');
    const monthlyData = JSON.parse('{{ monthly_data|tojson|safe }}');
    const categoryTrendLabels = JSON.parse('{{ category_trend_labels|tojson|safe }}');
    const categoryTrendData = JSON.parse('{{ category_trend_data|tojson|safe }}');
    const dateRangeLabels = JSON.parse('{{ date_range_labels|tojson|safe }}');
    const dateRangeData = JSON.parse('{{ date_range_data|tojson|safe }}');
    const timeRangeLabels = JSON.parse('{{ time_range_labels|tojson|safe }}');
    const timeRangeData = JSON.parse('{{ time_range_data|tojson|safe }}');

    // Category Chart
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    new Chart(categoryCtx, {
        type: 'pie',
        data: {
            labels: categoryLabels,
            datasets: [{
                data: categoryData,
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF',
                    '#FF9F40'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });

    // Monthly Chart
    const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
    new Chart(monthlyCtx, {
        type: 'line',
        data: {
            labels: monthlyLabels,
            datasets: [{
                label: 'Monthly Expenses',
                data: monthlyData,
                borderColor: '#36A2EB',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Category Trend Chart
    {% if category_report %}
    const categoryTrendCtx = document.getElementById('categoryTrendChart').getContext('2d');
    new Chart(categoryTrendCtx, {
        type: 'line',
        data: {
            labels: categoryTrendLabels,
            datasets: [{
                label: 'Category Expenses',
                data: categoryTrendData,
                borderColor: '#FF6384',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    {% endif %}

    // Date Range Chart
    {% if date_report %}
    const dateRangeCtx = document.getElementById('dateRangeChart').getContext('2d');
    new Chart(dateRangeCtx, {
        type: 'bar',
        data: {
            labels: dateRangeLabels,
            datasets: [{
                label: 'Daily Expenses',
                data: dateRangeData,
                backgroundColor: '#36A2EB'
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    {% endif %}

    // Time Range Chart
    {% if time_report %}
    const timeRangeCtx = document.getElementById('timeRangeChart').getContext('2d');
    new Chart(timeRangeCtx, {
        type: 'bar',
        data: {
            labels: timeRangeLabels,
            datasets: [{
                label: 'Hourly Expenses',
                data: timeRangeData,
                backgroundColor: '#FF6384'
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    {% endif %}
</script>
{% endblock %} 